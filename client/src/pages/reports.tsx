import { useState, useEffect, useMemo } from "react";
import { useAuth } from "@/hooks/use-auth";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { useWebSocket } from "@/hooks/use-websocket";
import { Header } from "@/components/layout/header";
import { FloatingShapes } from "@/components/ui/floating-shapes";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { 
  FileText, 
  Calendar, 
  TrendingUp,
  Clock,
  BarChart3,
  PieChart,
  Users,
  CheckCircle,
  AlertTriangle,
  Download,
  Printer,
  Share2,
  ChevronLeft,
  ChevronRight,
  Eye,
  Table,
  Target,
  ArrowRight,
  Timer,
  AlertCircle
} from "lucide-react";
import { format, startOfWeek, endOfWeek, startOfMonth, endOfMonth, startOfYear, endOfYear, addDays, addWeeks, addMonths, addYears, eachDayOfInterval, eachWeekOfInterval, eachMonthOfInterval, startOfDay, isSameDay, differenceInHours, differenceInDays } from "date-fns";
import { ko } from "date-fns/locale";
import type { DailyTaskWithDetails } from "../../../shared/schema";
import { useToast } from "@/hooks/use-toast";

interface DailyTaskWithDetails {
  id: number;
  title: string;
  description?: string;
  status: 'scheduled' | 'in_progress' | 'completed' | 'cancelled' | 'postponed';
  priority: 'low' | 'medium' | 'high' | 'urgent';
  category: string;
  assignedTo: string;
  followUpAssignee?: string;
  progress?: number;
  workDate?: string;
  createdAt: string;
  estimatedHours?: number;
  actualHours?: number;
  startedAt?: string;
  completedAt?: string;
  targetPlace?: string;
}

interface TaskFlowItem {
  from: string;
  to: string;
  taskTitle: string;
  taskId: number;
  assignedDate: string;
  status: string;
}

interface ReportMetrics {
  totalTasks: number;
  completedTasks: number;
  inProgressTasks: number;
  postponedTasks: number;
  cancelledTasks: number;
  scheduledTasks: number;
  completionRate: number;
  averageProgress: number;
  totalEstimatedHours: number;
  totalActualHours: number;
  efficiencyRate: number;
  categoryBreakdown: { [key: string]: number };
  priorityBreakdown: { [key: string]: number };
  priorityCompletionRates: { [key: string]: number };
  categoryProductivity: { [key: string]: number };
  dailyProductivity: { [key: string]: number };
  timeToStart: { average: number; breakdown: { [key: string]: number } };
  timeToComplete: { average: number; breakdown: { [key: string]: number } };
  focusHours: { [key: string]: number };
  taskFlow: TaskFlowItem[];
  tasksInPeriod: DailyTaskWithDetails[];
}

export default function Reports() {
  const { user } = useAuth();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [reportType, setReportType] = useState<"daily" | "weekly" | "monthly" | "yearly">("daily");
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [reportData, setReportData] = useState<ReportMetrics | null>(null);
  const [currentView, setCurrentView] = useState<"employee" | "manager">(
    user?.role === "developer" || user?.role === "manager" ? "manager" : "employee"
  );
  const [showPrintPreview, setShowPrintPreview] = useState(false);

  // WebSocket Ïó∞Í≤∞ (Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏)
  const { lastMessage } = useWebSocket();

  // ÏóÖÎ¨¥ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (Ïã§ÏãúÍ∞Ñ Ïó∞Îèô)
  const { 
    data: tasks = [], 
    isLoading, 
    error, 
    refetch 
  } = useQuery<DailyTaskWithDetails[]>({
    queryKey: ['tasks'],
    queryFn: async () => {
      const response = await fetch('/api/tasks', {
        credentials: 'include',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error('ÏóÖÎ¨¥ Î™©Î°ù Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
      
      const data = await response.json();
      return data?.tasks || [];
    },
    retry: 3,
    refetchInterval: 10000,
    staleTime: 5000
  });

  // WebSocket Î©îÏãúÏßÄ Ï≤òÎ¶¨
  useEffect(() => {
    if (lastMessage?.data) {
      try {
        const data = JSON.parse(lastMessage.data);
        console.log('üì® WebSocket Î©îÏãúÏßÄ ÏàòÏã† (Î≥¥Í≥†ÏÑú):', data.type);
        
        if (data.type === 'TASK_UPDATE' || 
            data.type === 'task_created' || 
            data.type === 'task_updated' || 
            data.type === 'task_deleted') {
          queryClient.invalidateQueries({ queryKey: ['tasks'] });
        }
      } catch (error) {
        console.error('WebSocket Î©îÏãúÏßÄ ÌååÏã± Ïò§Î•ò:', error);
      }
    }
  }, [lastMessage, queryClient, toast]);

  // Î≥¥Í≥†ÏÑú Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞
  const reportAnalytics = useMemo((): ReportMetrics | null => {
    if (!tasks.length) return null;

    // ÏÑ†ÌÉùÎêú Í∏∞Í∞ÑÏóê Ìï¥ÎãπÌïòÎäî ÏóÖÎ¨¥ ÌïÑÌÑ∞ÎßÅ
    const tasksInPeriod = tasks.filter(task => {
      const taskDate = new Date(task.workDate || task.createdAt);
      const selectedStart = startOfDay(selectedDate);
      
      switch (reportType) {
        case 'daily':
          return isSameDay(taskDate, selectedStart);
        case 'weekly':
          const weekStart = startOfWeek(selectedDate, { weekStartsOn: 1 });
          const weekEnd = endOfWeek(selectedDate, { weekStartsOn: 1 });
          return taskDate >= weekStart && taskDate <= weekEnd;
        case 'monthly':
          const monthStart = startOfMonth(selectedDate);
          const monthEnd = endOfMonth(selectedDate);
          return taskDate >= monthStart && taskDate <= monthEnd;
        case 'yearly':
          const yearStart = startOfYear(selectedDate);
          const yearEnd = endOfYear(selectedDate);
          return taskDate >= yearStart && taskDate <= yearEnd;
        default:
          return false;
      }
    });

    const totalTasks = tasksInPeriod.length;
    if (totalTasks === 0) {
      return {
        totalTasks: 0,
        completedTasks: 0,
        inProgressTasks: 0,
        postponedTasks: 0,
        cancelledTasks: 0,
        scheduledTasks: 0,
        completionRate: 0,
        averageProgress: 0,
        totalEstimatedHours: 0,
        totalActualHours: 0,
        efficiencyRate: 0,
        categoryBreakdown: {},
        priorityBreakdown: {},
        priorityCompletionRates: {},
        categoryProductivity: {},
        dailyProductivity: {},
        timeToStart: { average: 0, breakdown: {} },
        timeToComplete: { average: 0, breakdown: {} },
        focusHours: {},
        taskFlow: [],
        tasksInPeriod: []
      };
    }

    // ÏÉÅÌÉúÎ≥Ñ ÌÜµÍ≥Ñ
    const completedTasks = tasksInPeriod.filter(t => t.status === 'completed').length;
    const inProgressTasks = tasksInPeriod.filter(t => t.status === 'in_progress').length;
    const postponedTasks = tasksInPeriod.filter(t => t.status === 'postponed').length;
    const cancelledTasks = tasksInPeriod.filter(t => t.status === 'cancelled').length;
    const scheduledTasks = tasksInPeriod.filter(t => t.status === 'scheduled').length;

    // ÏôÑÎ£åÏú® Í≥ÑÏÇ∞
    const completionRate = Math.round((completedTasks / totalTasks) * 100);

    // ÌèâÍ∑† ÏßÑÌñâÎ•† Í≥ÑÏÇ∞
    const totalProgress = tasksInPeriod.reduce((sum, task) => sum + (task.progress || 0), 0);
    const averageProgress = Math.round(totalProgress / totalTasks);

    // ÏãúÍ∞Ñ ÌÜµÍ≥Ñ
    const totalEstimatedHours = tasksInPeriod.reduce((sum, task) => sum + (task.estimatedHours || 0), 0);
    const totalActualHours = tasksInPeriod.reduce((sum, task) => sum + (task.actualHours || 0), 0);
    const efficiencyRate = totalEstimatedHours > 0 ? Math.round((totalActualHours / totalEstimatedHours) * 100) : 0;

    // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î∂ÑÌè¨
    const categoryBreakdown = tasksInPeriod.reduce((acc, task) => {
      acc[task.category] = (acc[task.category] || 0) + 1;
      return acc;
    }, {} as { [key: string]: number });

    // Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ Î∂ÑÌè¨
    const priorityBreakdown = tasksInPeriod.reduce((acc, task) => {
      acc[task.priority] = (acc[task.priority] || 0) + 1;
      return acc;
    }, {} as { [key: string]: number });

    // Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ ÏôÑÎ£åÏú®
    const priorityCompletionRates = Object.keys(priorityBreakdown).reduce((acc, priority) => {
      const totalPriorityTasks = tasksInPeriod.filter(t => t.priority === priority).length;
      const completedPriorityTasks = tasksInPeriod.filter(t => t.priority === priority && t.status === 'completed').length;
      acc[priority] = totalPriorityTasks > 0 ? Math.round((completedPriorityTasks / totalPriorityTasks) * 100) : 0;
      return acc;
    }, {} as { [key: string]: number });

    // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉùÏÇ∞ÏÑ± (ÏôÑÎ£åÎêú ÏóÖÎ¨¥/Ï†ÑÏ≤¥ ÏóÖÎ¨¥)
    const categoryProductivity = Object.keys(categoryBreakdown).reduce((acc, category) => {
      const totalCategoryTasks = tasksInPeriod.filter(t => t.category === category).length;
      const completedCategoryTasks = tasksInPeriod.filter(t => t.category === category && t.status === 'completed').length;
      acc[category] = totalCategoryTasks > 0 ? Math.round((completedCategoryTasks / totalCategoryTasks) * 100) : 0;
      return acc;
    }, {} as { [key: string]: number });

    // ÏóÖÎ¨¥ ÏòàÏ†ï‚ÜíÏßÑÌñâ ÏãúÍ∞Ñ Î∂ÑÏÑù
    const timeToStartData = tasksInPeriod
      .filter(task => task.startedAt && task.createdAt)
      .map(task => {
        const created = new Date(task.createdAt);
        const started = new Date(task.startedAt!);
        return {
          task,
          hours: differenceInHours(started, created)
        };
      });

    const averageTimeToStart = timeToStartData.length > 0 
      ? Math.round(timeToStartData.reduce((sum, item) => sum + item.hours, 0) / timeToStartData.length)
      : 0;

    // ÏóÖÎ¨¥ ÏßÑÌñâ‚ÜíÏôÑÎ£å ÏãúÍ∞Ñ Î∂ÑÏÑù
    const timeToCompleteData = tasksInPeriod
      .filter(task => task.completedAt && task.startedAt)
      .map(task => {
        const started = new Date(task.startedAt!);
        const completed = new Date(task.completedAt!);
        return {
          task,
          hours: differenceInHours(completed, started)
        };
      });

    const averageTimeToComplete = timeToCompleteData.length > 0
      ? Math.round(timeToCompleteData.reduce((sum, item) => sum + item.hours, 0) / timeToCompleteData.length)
      : 0;

    // ÏóÖÎ¨¥ÏßëÏ§ëÏãúÍ∞Ñ (ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏôÑÎ£å ÏóÖÎ¨¥ Ïàò)
    const focusHours = tasksInPeriod
      .filter(task => task.completedAt)
      .reduce((acc, task) => {
        const hour = new Date(task.completedAt!).getHours();
        const hourRange = `${hour}:00-${hour + 1}:00`;
        acc[hourRange] = (acc[hourRange] || 0) + 1;
        return acc;
      }, {} as { [key: string]: number });

    // ÏóÖÎ¨¥ FLOW Ï∂îÏ†Å (ÌõÑÏÜçÎã¥ÎãπÏûê ÏßÄÏ†ïÎêú ÏóÖÎ¨¥)
    const taskFlow: TaskFlowItem[] = tasksInPeriod
      .filter(task => task.followUpAssignee)
      .map(task => ({
        from: task.assignedTo,
        to: task.followUpAssignee!,
        taskTitle: task.title,
        taskId: task.id,
        assignedDate: task.workDate || task.createdAt,
        status: task.status
      }));

    return {
      totalTasks,
      completedTasks,
      inProgressTasks,
      postponedTasks,
      cancelledTasks,
      scheduledTasks,
      completionRate,
      averageProgress,
      totalEstimatedHours,
      totalActualHours,
      efficiencyRate,
      categoryBreakdown,
      priorityBreakdown,
      priorityCompletionRates,
      categoryProductivity,
      dailyProductivity: {},
      timeToStart: { 
        average: averageTimeToStart, 
        breakdown: timeToStartData.reduce((acc, item) => {
          acc[item.task.category] = (acc[item.task.category] || 0) + item.hours;
          return acc;
        }, {} as { [key: string]: number })
      },
      timeToComplete: { 
        average: averageTimeToComplete,
        breakdown: timeToCompleteData.reduce((acc, item) => {
          acc[item.task.category] = (acc[item.task.category] || 0) + item.hours;
          return acc;
        }, {} as { [key: string]: number })
      },
      focusHours,
      taskFlow,
      tasksInPeriod
    };
  }, [tasks, selectedDate, reportType]);

  // Í∏∞Í∞Ñ ÌëúÏãú Ìè¨Îß∑ÌåÖ
  const formatPeriodDisplay = () => {
    switch (reportType) {
      case 'daily':
        return format(selectedDate, 'yyyyÎÖÑ MMÏõî ddÏùº (EEE)', { locale: ko });
      case 'weekly':
        const weekStart = startOfWeek(selectedDate, { weekStartsOn: 1 });
        const weekEnd = endOfWeek(selectedDate, { weekStartsOn: 1 });
        return `${format(weekStart, 'MMÏõî ddÏùº', { locale: ko })} ~ ${format(weekEnd, 'MMÏõî ddÏùº', { locale: ko })}`;
      case 'monthly':
        return format(selectedDate, 'yyyyÎÖÑ MMÏõî', { locale: ko });
      case 'yearly':
        return format(selectedDate, 'yyyyÎÖÑ', { locale: ko });
      default:
        return '';
    }
  };

  // Í∏∞Í∞Ñ Ïù¥Îèô
  const navigatePeriod = (direction: 'prev' | 'next') => {
    const increment = direction === 'next' ? 1 : -1;
    
    switch (reportType) {
      case 'daily':
        setSelectedDate(addDays(selectedDate, increment));
        break;
      case 'weekly':
        setSelectedDate(addWeeks(selectedDate, increment));
        break;
      case 'monthly':
        setSelectedDate(addMonths(selectedDate, increment));
        break;
      case 'yearly':
        setSelectedDate(addYears(selectedDate, increment));
        break;
    }
  };

  // Î≥¥Í≥†ÏÑú ÌÉÄÏûÖ ÎùºÎ≤®
  const getReportTypeLabel = () => {
    switch (reportType) {
      case 'daily': return 'ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑú';
      case 'weekly': return 'Ï£ºÍ∞ÑÎ≥¥Í≥†ÏÑú';
      case 'monthly': return 'ÏõîÍ∞ÑÎ≥¥Í≥†ÏÑú';
      case 'yearly': return 'Ïó∞Í∞ÑÎ≥¥Í≥†ÏÑú';
      default: return 'Î≥¥Í≥†ÏÑú';
    }
  };

  // ÏÉÅÌÉúÎ≥Ñ ÏïÑÏù¥ÏΩò ÌëúÏãú Ìï®Ïàò
  const getStatusDisplay = (status: string) => {
    switch (status) {
      case 'scheduled': return { icon: 'üîµ', text: 'ÏòàÏ†ï' };
      case 'in_progress': return { icon: 'üü°', text: 'ÏßÑÌñâ' };
      case 'completed': return { icon: 'üü¢', text: 'ÏôÑÎ£å' };
      case 'cancelled': return { icon: 'üî¥', text: 'Ï∑®ÏÜå' };
      case 'postponed': return { icon: '‚è∏Ô∏è', text: 'Ïó∞Í∏∞' };
      default: return { icon: '‚ö™', text: 'ÎØ∏Ï†ï' };
    }
  };

  // Print and PDF functions
  const handlePrintPreview = () => {
    // Ïù∏ÏáÑ ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú ÌôúÏÑ±Ìôî
    setShowPrintPreview(true);
    
    // DOM Î†åÎçîÎßÅ ÏôÑÎ£å ÎåÄÍ∏∞ ÌõÑ Ïù∏ÏáÑ ÎåÄÌôîÏÉÅÏûê Ïó¥Í∏∞
    setTimeout(() => {
      window.print();
    }, 800); // Î†åÎçîÎßÅ ÏãúÍ∞Ñ Ï∂©Î∂ÑÌûà ÌôïÎ≥¥
    
    // Ïù∏ÏáÑ ÏôÑÎ£å ÌõÑ ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú Ìï¥Ï†ú
    setTimeout(() => {
      setShowPrintPreview(false);
    }, 2000); // Ïù∏ÏáÑ ÏôÑÎ£å ÎåÄÍ∏∞ ÏãúÍ∞Ñ Ï¶ùÍ∞Ä
  };

  const handleSavePDF = async () => {
    try {
      // ÏÇ¨Ïö©Ïûê ÏïàÎÇ¥ Î©îÏãúÏßÄ
      const userConfirm = window.confirm(
        'Î≥¥Í≥†ÏÑúÎ•º PDFÎ°ú Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n' +
        'ÌôïÏù∏ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Ïù∏ÏáÑ ÎåÄÌôîÏÉÅÏûêÍ∞Ä Ïó¥Î¶ΩÎãàÎã§.\n' +
        'ÎåÄÏÉÅÏùÑ "PDFÎ°ú Ï†ÄÏû•"ÏúºÎ°ú ÏÑ†ÌÉùÌïòÏó¨ Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.'
      );
      
      if (!userConfirm) {
        return;
      }

      // PDF Ï†ÄÏû•ÏùÑ ÏúÑÌïú ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú ÌôúÏÑ±Ìôî
    setShowPrintPreview(true);
      
      // DOM Î†åÎçîÎßÅ ÏôÑÎ£å ÎåÄÍ∏∞
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // ÌååÏùºÎ™Ö ÏÉùÏÑ±
      const fileName = `${getReportTypeLabel()}_${formatPeriodDisplay().replace(/[^\w\sÍ∞Ä-Ìû£]/g, '_')}_${format(new Date(), 'yyyyMMdd')}`;
      
      // Î∏åÎùºÏö∞Ï†Ä Ï†úÎ™© ÏûÑÏãú Î≥ÄÍ≤Ω (PDF ÌååÏùºÎ™ÖÏóê Î∞òÏòÅÎê®)
      const originalTitle = document.title;
      document.title = fileName;
      
      // PDF Ï†ÄÏû•Ïö© Ïù∏ÏáÑ ÎåÄÌôîÏÉÅÏûê Ïó¥Í∏∞
      window.print();
      
      // Ï†úÎ™© Î≥µÏõê Î∞è ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú Ìï¥Ï†ú
      setTimeout(() => {
        document.title = originalTitle;
      setShowPrintPreview(false);
      }, 2000);
      
    } catch (error) {
      console.error('PDF Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
      alert('PDF Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
      setShowPrintPreview(false);
    }
  };

  // Compact summary cards for A4 printing
  const renderCompactSummaryCards = () => {
    if (!reportAnalytics) return null;

    return (
              <div className="grid grid-cols-4 gap-2 mb-4 print:mb-3">
          <div className="bg-gray-50 border border-gray-300 rounded-lg p-3 text-center">
            <div className="text-gray-700 font-bold text-lg">{reportAnalytics.scheduledTasks}</div>
            <div className="text-gray-600 text-xs font-medium">üîµ ÏòàÏ†ï</div>
          </div>
          <div className="bg-gray-100 border border-gray-400 rounded-lg p-3 text-center">
            <div className="text-gray-800 font-bold text-lg">{reportAnalytics.inProgressTasks}</div>
            <div className="text-gray-700 text-xs font-medium">üü° ÏßÑÌñâ</div>
          </div>
          <div className="bg-gray-50 border border-gray-300 rounded-lg p-3 text-center">
            <div className="text-gray-700 font-bold text-lg">{reportAnalytics.completedTasks}</div>
            <div className="text-gray-600 text-xs font-medium">üü¢ ÏôÑÎ£å</div>
          </div>
          <div className="bg-gray-100 border border-gray-400 rounded-lg p-3 text-center">
            <div className="text-gray-800 font-bold text-lg">{reportAnalytics.cancelledTasks}</div>
            <div className="text-gray-700 text-xs font-medium">üî¥ Ï∑®ÏÜå</div>
          </div>
        </div>
    );
  };

  // Compact metrics for A4 printing (ÏÉâÏÉÅ Î≥ÄÍ≤Ω: ÌöåÏÉâ Í≥ÑÏó¥)
  const renderCompactMetrics = () => {
    if (!reportAnalytics) return null;

    return (
      <div className="grid grid-cols-2 gap-4 mb-4 print:mb-3">
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
          <h4 className="text-gray-800 font-semibold text-sm mb-2">üìà ÏÑ±Í≥º ÏßÄÌëú</h4>
          <div className="space-y-1 text-xs">
            <div className="flex justify-between">
              <span className="text-gray-700">ÏôÑÎ£åÏú®</span>
              <span className="font-semibold">{reportAnalytics.completionRate}%</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-700">ÌèâÍ∑† ÏßÑÌñâÎ•†</span>
              <span className="font-semibold">{reportAnalytics.averageProgress}%</span>
            </div>
          </div>
        </div>
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
          <h4 className="text-gray-800 font-semibold text-sm mb-2">üìä Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Î∂ÑÌè¨</h4>
          <div className="space-y-1 text-xs">
            {Object.entries(reportAnalytics.categoryBreakdown).slice(0, 3).map(([category, count]) => (
              <div key={category} className="flex justify-between">
                <span className="text-gray-700">{category}</span>
                <span className="font-semibold">{count}Í∞ú</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  // Compact task table for A4 printing (ÏÉâÏÉÅ Î≥ÄÍ≤Ω: ÌöåÏÉâ Í≥ÑÏó¥)
  const renderCompactTaskTable = (tasks: DailyTaskWithDetails[], title: string) => {
    const hasNoTasks = !tasks.length;

    return (
      <div className="mb-4 print:mb-3 page-break-inside-avoid">
        <div className="flex items-center justify-between mb-2">
          <h4 className="text-gray-800 font-semibold text-sm flex items-center gap-2">
            <span>{title}</span>
            {hasNoTasks && (
              <span className="text-gray-500 text-xs font-normal ml-2">
                - Ìï¥ÎãπÍ∏∞Í∞ÑÏùò ÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§
              </span>
            )}
          </h4>
          {!hasNoTasks && (
            <span className="text-xs text-gray-600">({tasks.length}Í∞ú)</span>
          )}
        </div>
        
        {!hasNoTasks && (
          <div className="overflow-hidden border border-gray-200 rounded-lg">
            <table className="w-full text-xs">
              <thead className="bg-gray-50">
                <tr>
                  <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[120px]">ÏùºÏûê</th>
                  <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[120px]">ÏóÖÎ¨¥ Ï†úÎ™©</th>
                  <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[80px]">ÏÉÅÌÉú</th>
                  <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[90px]">Ïö∞ÏÑ†ÏàúÏúÑ</th>
                  <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[90px]">Îã¥ÎãπÏûê</th>
                  <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[100px]">ÏßÑÌñâÎ•†</th>
                </tr>
              </thead>
              <tbody>
                {tasks.sort((a, b) => new Date(a.workDate || a.createdAt).getTime() - new Date(b.workDate || b.createdAt).getTime()).map((task, index) => {
                  const statusInfo = getStatusDisplay(task.status);
                  const taskDate = new Date(task.workDate || task.createdAt);
                  const dateOnly = format(taskDate, 'MM/dd', { locale: ko });
                  const dayOnly = format(taskDate, '(EEE)', { locale: ko });
                  const scheduledTime = format(taskDate, 'HH:mm');
                  const isSaturday = taskDate.getDay() === 6;
                  const isSunday = taskDate.getDay() === 0;
                  
                  return (
                    <tr key={task.id} className={index % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                                                       <td className="p-2 border-b border-gray-100 text-center">
                                   <div className="text-sm font-bold text-gray-800">
                                     {dateOnly}<span className={isSunday ? 'text-red-500' : isSaturday ? 'text-blue-500' : 'text-gray-800'}>{dayOnly}</span>
                                   </div>
                                   <div className="text-sm text-gray-900">
                                     {scheduledTime}
                                   </div>
                      </td>
                      <td className="p-2 border-b border-gray-100 font-medium">
                        <div>
                          <div>
                            <span className="font-bold text-gray-800 bg-gray-300 px-2 py-1 rounded mr-2">
                              {task.targetPlace || 'ÎØ∏ÏßÄÏ†ï'}
                        </span>
                            <span className="font-semibold">
                              {task.title.startsWith('[ÌôïÏù∏ÏöîÏ≤≠]') ? 'üî¥ ' : ''}{task.title}
                            </span>
                          </div>
                          {task.description && (
                            <div className="text-sm text-gray-500 mt-1 truncate max-w-xs">
                              {task.description}
                            </div>
                          )}
                        </div>
                      </td>
                      <td className="p-2 border-b border-gray-100">
                        <div className="flex items-center gap-1">
                          <span className={`text-lg ${
                            task.status === 'completed' ? 'text-green-600' :
                            task.status === 'in_progress' ? 'text-yellow-500' :
                            task.status === 'scheduled' ? 'text-blue-600' :
                            task.status === 'postponed' ? 'text-gray-500' :
                            task.status === 'cancelled' ? 'text-red-600' : 'text-gray-400'
                          }`}>‚óè</span>
                          <span className="text-xs">{statusInfo.text}</span>
                        </div>
                      </td>
                      <td className="p-2 border-b border-gray-100">
                        <span className={`px-2 py-1 rounded text-xs ${
                          task.priority === 'urgent' ? 'bg-red-100 text-red-800' :
                          task.priority === 'high' ? 'bg-orange-100 text-orange-800' :
                          task.priority === 'medium' ? 'bg-blue-100 text-blue-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>
                          {task.priority === 'urgent' ? 'Í∏¥Í∏â' :
                           task.priority === 'high' ? 'ÎÜíÏùå' :
                           task.priority === 'medium' ? 'Î≥¥ÌÜµ' : 'ÎÇÆÏùå'}
                        </span>
                      </td>
                      <td className="p-2 border-b border-gray-100">{task.assignedTo}</td>
                      <td className="p-2 border-b border-gray-100">
                        <div className="flex items-center gap-1">
                          <div className="w-12 bg-gray-200 rounded-full h-1">
                            <div 
                              className="bg-gray-600 h-1 rounded-full" 
                              style={{ width: `${task.progress || 0}%` }}
                            ></div>
                          </div>
                          <span className="text-xs">{task.progress || 0}%</span>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>
    );
  };

  const renderDetailedReportCompact = () => {
    if (!reportAnalytics || !reportAnalytics.tasksInPeriod.length) {
      return (
        <div className="text-center py-4">
          <p className="text-gray-600 text-sm">ÏÑ†ÌÉùÎêú Í∏∞Í∞ÑÏóê Ìï¥ÎãπÌïòÎäî ÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
        </div>
      );
    }

    switch (reportType) {
      case "daily":
        return renderCompactTaskTable(reportAnalytics.tasksInPeriod, `${formatPeriodDisplay()} ÏóÖÎ¨¥ Î™©Î°ù`);
      
      case "weekly":
        // Ï£ºÍ∞ÑÎ≥¥Í≥†ÏÑú: ÎÇ†Ïßú Ï§ëÍ∞ÑÏ†úÎ™© ÏóÜÏù¥ Î™®Îì† ÏóÖÎ¨¥Î•º ÌïòÎÇòÏùò ÌÖåÏù¥Î∏îÎ°ú ÌëúÏãú
        return renderCompactTaskTable(reportAnalytics.tasksInPeriod, `${formatPeriodDisplay()} ÏóÖÎ¨¥ Î™©Î°ù`);
      
      case "monthly":
        const weeks = eachWeekOfInterval({
          start: startOfMonth(selectedDate),
          end: endOfMonth(selectedDate)
        }, { weekStartsOn: 1 });
        
        return (
          <div className="space-y-1">
            {weeks.map((weekStart, index) => {
              const weekEnd = endOfWeek(weekStart, { weekStartsOn: 1 });
              const weekTasks = reportAnalytics.tasksInPeriod.filter(task => {
                const taskDate = new Date(task.workDate || task.createdAt);
                return taskDate >= weekStart && taskDate <= weekEnd;
              });
              
              // Ï£ºÏ∞®Î≥Ñ ÏùåÏòÅ Íµ¨Î∂Ñ (ÌôÄÏàò Ï£ºÏ∞®Îäî Ìù∞ÏÉâ, ÏßùÏàò Ï£ºÏ∞®Îäî ÌöåÏÉâ Î∞∞Í≤Ω)
              const isEvenWeek = (index + 1) % 2 === 0;
              
              return (
                <div 
                  key={weekStart.toISOString()} 
                  className={`${isEvenWeek ? 'bg-gray-50' : 'bg-white'} p-3 rounded-lg border border-gray-200`}
                >
                  <div className="mb-2">
                    <h4 className="text-gray-800 font-semibold text-sm flex items-center gap-2">
                      <span>{index + 1}Ï£ºÏ∞® ({format(weekStart, 'MM/dd', { locale: ko })} ~ {format(weekEnd, 'MM/dd', { locale: ko })})</span>
                      {weekTasks.length === 0 && (
                        <span className="text-gray-500 text-xs font-normal ml-2">
                          - Ìï¥ÎãπÍ∏∞Í∞ÑÏùò ÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§
                        </span>
                      )}
                      {weekTasks.length > 0 && (
                        <span className="text-xs text-gray-600">({weekTasks.length}Í∞ú)</span>
                      )}
                    </h4>
                  </div>
                  
                  {weekTasks.length > 0 && (
                    <div className="overflow-hidden border border-gray-200 rounded-lg">
                      <table className="w-full text-xs">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[120px]">ÏùºÏûê</th>
                            <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[120px]">ÏóÖÎ¨¥ Ï†úÎ™©</th>
                            <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[80px]">ÏÉÅÌÉú</th>
                            <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[90px]">Ïö∞ÏÑ†ÏàúÏúÑ</th>
                            <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[90px]">Îã¥ÎãπÏûê</th>
                            <th className="text-left p-2 font-semibold text-gray-800 border-b min-w-[100px]">ÏßÑÌñâÎ•†</th>
                          </tr>
                        </thead>
                        <tbody>
                          {weekTasks.sort((a, b) => new Date(a.workDate || a.createdAt).getTime() - new Date(b.workDate || b.createdAt).getTime()).map((task, taskIndex) => {
                            const statusInfo = getStatusDisplay(task.status);
                            const taskDate = new Date(task.workDate || task.createdAt);
                            const dateOnly = format(taskDate, 'MM/dd', { locale: ko });
                            const dayOnly = format(taskDate, '(EEE)', { locale: ko });
                            const scheduledTime = format(taskDate, 'HH:mm');
                            const isSaturday = taskDate.getDay() === 6;
                            const isSunday = taskDate.getDay() === 0;
                            
                            return (
                              <tr key={task.id} className={taskIndex % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                                <td className="p-2 border-b border-gray-100 text-center">
                                  <div className="text-sm font-bold text-gray-800">
                                    {dateOnly}<span className={isSunday ? 'text-red-500' : isSaturday ? 'text-blue-500' : 'text-gray-800'}>{dayOnly}</span>
                                  </div>
                                  <div className="text-sm text-gray-900">
                                    {scheduledTime}
                                  </div>
                                </td>
                                <td className="p-2 border-b border-gray-100 font-medium">
                                  <div>
                                    <div>
                                      <span className="font-bold text-gray-800 bg-gray-300 px-2 py-1 rounded mr-2">
                                        {task.targetPlace || 'ÎØ∏ÏßÄÏ†ï'}
                                      </span>
                                      <span className="font-semibold">
                                        {task.title.startsWith('[ÌôïÏù∏ÏöîÏ≤≠]') ? 'üî¥ ' : ''}{task.title}
                                      </span>
                                    </div>
                                    {task.description && (
                                      <div className="text-sm text-gray-500 mt-1 truncate max-w-xs">
                                        {task.description}
                                      </div>
                                    )}
                                  </div>
                                </td>
                                <td className="p-2 border-b border-gray-100">
                                  <div className="flex items-center gap-1">
                                    <span className={`text-lg ${
                                      task.status === 'completed' ? 'text-green-600' :
                                      task.status === 'in_progress' ? 'text-yellow-500' :
                                      task.status === 'scheduled' ? 'text-blue-600' :
                                      task.status === 'postponed' ? 'text-gray-500' :
                                      task.status === 'cancelled' ? 'text-red-600' : 'text-gray-400'
                                    }`}>‚óè</span>
                                    <span className="text-xs">{statusInfo.text}</span>
                                  </div>
                                </td>
                                <td className="p-2 border-b border-gray-100">
                                  <span className={`px-2 py-1 rounded text-xs ${
                                    task.priority === 'urgent' ? 'bg-red-100 text-red-800' :
                                    task.priority === 'high' ? 'bg-orange-100 text-orange-800' :
                                    task.priority === 'medium' ? 'bg-blue-100 text-blue-800' :
                                    'bg-gray-100 text-gray-800'
                                  }`}>
                                    {task.priority === 'urgent' ? 'Í∏¥Í∏â' :
                                     task.priority === 'high' ? 'ÎÜíÏùå' :
                                     task.priority === 'medium' ? 'Î≥¥ÌÜµ' : 'ÎÇÆÏùå'}
                                  </span>
                                </td>
                                <td className="p-2 border-b border-gray-100">{task.assignedTo}</td>
                                <td className="p-2 border-b border-gray-100">
                                  <div className="flex items-center gap-1">
                                    <div className="w-12 bg-gray-200 rounded-full h-1">
                                      <div 
                                        className="bg-gray-600 h-1 rounded-full" 
                                        style={{ width: `${task.progress || 0}%` }}
                                      ></div>
                                    </div>
                                    <span className="text-xs">{task.progress || 0}%</span>
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        );
      
      case "yearly":
        const months = eachMonthOfInterval({
          start: startOfYear(selectedDate),
          end: endOfYear(selectedDate)
        });
        
        return (
          <div className="space-y-3">
            {months.map(month => {
              const monthTasks = reportAnalytics.tasksInPeriod.filter(task => {
                const taskDate = new Date(task.workDate || task.createdAt);
                return taskDate >= startOfMonth(month) && taskDate <= endOfMonth(month);
              });
              return renderCompactTaskTable(
                monthTasks, 
                `${format(month, 'MMÏõî', { locale: ko })}`
              );
            })}
          </div>
        );
      
      default:
        return renderCompactTaskTable(reportAnalytics.tasksInPeriod, "ÏóÖÎ¨¥ Î™©Î°ù");
    }
  };

  // Í∏∞Î≥∏Î∂ÑÏÑùÎÇ¥Ïö© Î†åÎçîÎßÅ
  const renderDetailedAnalysis = () => {
    if (!reportAnalytics) return null;

    return (
      <div className="space-y-4 mb-6">
        {/* ÏßÑÌñâÏãúÍ∞Ñ Î∂ÑÏÑù */}
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h4 className="text-gray-800 font-semibold text-sm mb-3 flex items-center gap-2">
            <Timer className="w-4 h-4" />
            ÏßÑÌñâÏãúÍ∞Ñ Î∂ÑÏÑù
          </h4>
          <div className="grid grid-cols-2 gap-4 text-xs">
            <div>
              <div className="flex justify-between mb-1">
                <span className="text-gray-600">ÏóÖÎ¨¥ ÏòàÏ†ï‚ÜíÏßÑÌñâ ÌèâÍ∑†ÏãúÍ∞Ñ</span>
                <span className="font-semibold">{reportAnalytics.timeToStart.average}ÏãúÍ∞Ñ</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ÏóÖÎ¨¥ ÏßÑÌñâ‚ÜíÏôÑÎ£å ÌèâÍ∑†ÏãúÍ∞Ñ</span>
                <span className="font-semibold">{reportAnalytics.timeToComplete.average}ÏãúÍ∞Ñ</span>
              </div>
            </div>
            <div>
              <div className="flex justify-between mb-1">
                <span className="text-gray-600">ÏóÖÎ¨¥ÏôÑÎ£åÏú®</span>
                <span className="font-semibold">{reportAnalytics.completionRate}%</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ÌèâÍ∑† ÏßÑÌñâÎ•†</span>
                <span className="font-semibold">{reportAnalytics.averageProgress}%</span>
              </div>
            </div>
          </div>
        </div>

        {/* Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ ÏôÑÎ£åÏú® */}
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h4 className="text-gray-800 font-semibold text-sm mb-3 flex items-center gap-2">
            <AlertCircle className="w-4 h-4" />
            Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ ÏóÖÎ¨¥ÏôÑÎ£åÏú®
          </h4>
          <div className="grid grid-cols-2 gap-2 text-xs">
            {Object.entries(reportAnalytics.priorityCompletionRates).map(([priority, rate]) => (
              <div key={priority} className="flex justify-between">
                <span className="text-gray-600">
                  {priority === 'urgent' ? 'Í∏¥Í∏â' :
                   priority === 'high' ? 'ÎÜíÏùå' :
                   priority === 'medium' ? 'Î≥¥ÌÜµ' : 'ÎÇÆÏùå'}
                </span>
                <span className="font-semibold">{rate}%</span>
              </div>
            ))}
          </div>
        </div>

        {/* Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉùÏÇ∞ÏÑ± */}
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h4 className="text-gray-800 font-semibold text-sm mb-3 flex items-center gap-2">
            <BarChart3 className="w-4 h-4" />
            Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉùÏÇ∞ÏÑ±
          </h4>
          <div className="grid grid-cols-2 gap-2 text-xs">
            {Object.entries(reportAnalytics.categoryProductivity).slice(0, 6).map(([category, productivity]) => (
              <div key={category} className="flex justify-between">
                <span className="text-gray-600">{category}</span>
                <span className="font-semibold">{productivity}%</span>
              </div>
            ))}
          </div>
        </div>

        {/* ÏóÖÎ¨¥ÏßëÏ§ëÏãúÍ∞Ñ */}
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h4 className="text-gray-800 font-semibold text-sm mb-3 flex items-center gap-2">
            <Clock className="w-4 h-4" />
            ÏóÖÎ¨¥ÏßëÏ§ëÏãúÍ∞Ñ (ÏôÑÎ£å Í∏∞Ï§Ä)
          </h4>
          <div className="grid grid-cols-3 gap-2 text-xs">
            {Object.entries(reportAnalytics.focusHours)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 6)
              .map(([timeRange, count]) => (
              <div key={timeRange} className="flex justify-between">
                <span className="text-gray-600">{timeRange}</span>
                <span className="font-semibold">{count}Í±¥</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  // ÏóÖÎ¨¥FLOW Ìï≠Î™© Î†åÎçîÎßÅ
  const renderTaskFlow = () => {
    if (!reportAnalytics || !reportAnalytics.taskFlow.length) {
      return (
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
          <h4 className="text-gray-800 font-semibold text-sm mb-2 flex items-center gap-2">
            <ArrowRight className="w-4 h-4" />
            ÏóÖÎ¨¥FLOW - ÏóÖÎ¨¥Ï∂îÏ†Å (ÌõÑÏÜçÎã¥ÎãπÏûê ÏßÄÏ†ï)
            <span className="text-gray-500 text-xs font-normal ml-2">
              - Ìï¥ÎãπÍ∏∞Í∞ÑÏùò ÌõÑÏÜçÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§
            </span>
          </h4>
        </div>
      );
    }

    return (
      <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
        <h4 className="text-gray-800 font-semibold text-sm mb-3 flex items-center gap-2">
          <ArrowRight className="w-4 h-4" />
          ÏóÖÎ¨¥FLOW - ÏóÖÎ¨¥Ï∂îÏ†Å (ÌõÑÏÜçÎã¥ÎãπÏûê ÏßÄÏ†ï)
          <span className="text-xs text-gray-600 ml-2">({reportAnalytics.taskFlow.length}Í±¥)</span>
        </h4>
        <div className="space-y-2">
          {reportAnalytics.taskFlow.map((flow, index) => (
            <div key={index} className="bg-white border border-gray-200 rounded p-2 text-xs">
              <div className="flex items-center gap-2 mb-1">
                <span className="font-semibold text-gray-700">{flow.from}</span>
                <ArrowRight className="w-3 h-3 text-gray-500" />
                <span className="font-semibold text-gray-700">{flow.to}</span>
                <span className={`px-2 py-1 rounded text-xs ${
                  flow.status === 'completed' ? 'bg-green-100 text-green-800' :
                  flow.status === 'in_progress' ? 'bg-yellow-100 text-yellow-800' :
                  flow.status === 'scheduled' ? 'bg-blue-100 text-blue-800' :
                  'bg-gray-100 text-gray-800'
                }`}>
                  {flow.status === 'completed' ? 'ÏôÑÎ£å' :
                   flow.status === 'in_progress' ? 'ÏßÑÌñâÏ§ë' :
                   flow.status === 'scheduled' ? 'ÏòàÏ†ï' : 'Í∏∞ÌÉÄ'}
                </span>
              </div>
              <div className="text-gray-600">{flow.taskTitle}</div>
              <div className="text-gray-500 text-xs mt-1">
                ÏßÄÏ†ïÏùº: {format(new Date(flow.assignedDate), 'MM/dd', { locale: ko })}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // Ïù∏ÏáÑ Î™®ÎìúÏùº ÎïåÎäî ÏôÑÏ†ÑÌûà Îã§Î•∏ Î†åÎçîÎßÅ
  if (showPrintPreview) {
  return (
      <div className="print-mode">
        <div className="print-header mb-6">
          <div className="text-center border-b-2 border-gray-300 pb-4 mb-4">
            <h1 className="text-2xl font-bold text-gray-800">üìä {getReportTypeLabel()}</h1>
            <p className="text-gray-600 mt-1">{formatPeriodDisplay()} | ÏóÖÎ¨¥ Ïã§Ï†Å Î≥¥Í≥†ÏÑú</p>
            <p className="text-sm text-gray-500 mt-1">Ï∂úÎ†•Ïùº: {format(new Date(), 'yyyyÎÖÑ MMÏõî ddÏùº', { locale: ko })}</p>
          </div>
        </div>

        {!isLoading && reportAnalytics && (
          <div className="space-y-4">
            {/* Page 1: Compact Summary Analysis */}
            <div className="bg-white p-4 rounded-lg border page-break-inside-avoid">
              <div className="mb-3">
                <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                  <Eye className="w-5 h-5" />
                  Page 1: ÏöîÏïΩ Î∂ÑÏÑù
                </h3>
                <p className="text-gray-600 text-sm mb-4">
                  {getReportTypeLabel()} ÏóÖÎ¨¥ ÏÑ±Í≥º Î∞è ÌïµÏã¨ ÏßÄÌëú
                </p>
                
                {/* Compact Summary Cards */}
                {renderCompactSummaryCards()}
                
                {/* Compact Metrics */}
                {renderCompactMetrics()}
              </div>
            </div>

            {/* Page 2+: Detailed Task Tables */}
            <div className="bg-white p-4 rounded-lg border">
              <div className="mb-3">
                <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                  <Table className="w-5 h-5" />
                  Page 2+: ÏÉÅÏÑ∏ ÏóÖÎ¨¥ Î™©Î°ù
                </h3>
                <p className="text-gray-600 text-sm mb-4">
                  {reportType === 'daily' ? 'Ìï¥ÎãπÏùºÏùò ÏóÖÎ¨¥ÎÇ¥Ïö© Ï†ÑÏ≤¥' :
                   reportType === 'weekly' ? 'Í∞Å ÏùºÎ≥Ñ ÏóÖÎ¨¥ÎÇ¥Ïö© Ï†ÑÏ≤¥' :
                   reportType === 'monthly' ? 'Í∞Å Ï£ºÎ≥Ñ ÏóÖÎ¨¥ÎÇ¥Ïö©' :
                   'Í∞Å ÏõîÎ≥Ñ ÏóÖÎ¨¥ÎÇ¥Ïö©'} Ìëú ÌòïÌÉú ÎÇòÏó¥
                </p>
                
                {renderDetailedReportCompact()}
              </div>
            </div>

            {/* Page 3+: Comprehensive Analysis */}
            <div className="bg-white p-4 rounded-lg border">
              <div className="mb-3">
                <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                  <BarChart3 className="w-5 h-5" />
                  Page 3+: Ï¢ÖÌï© Î∂ÑÏÑù
                </h3>
                <p className="text-gray-600 text-sm mb-4">
                  Í∏∞Î≥∏Î∂ÑÏÑùÎÇ¥Ïö© - ÏãúÍ∞ÑÎ∂ÑÏÑù, ÏôÑÎ£åÏú®, Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ Î∂ÑÏÑù, Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉùÏÇ∞ÏÑ±, ÏóÖÎ¨¥ÏßëÏ§ëÏãúÍ∞Ñ
                </p>
                
                {renderDetailedAnalysis()}
              </div>
            </div>

            {/* Page 4+: Task Flow Analysis */}
            <div className="bg-white p-4 rounded-lg border">
              <div className="mb-3">
                <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                  <ArrowRight className="w-5 h-5" />
                  Page 4+: ÏóÖÎ¨¥FLOW Î∂ÑÏÑù
                </h3>
                <p className="text-gray-600 text-sm mb-4">
                  ÏóÖÎ¨¥FLOW Ìï≠Î™© - ÌõÑÏÜçÎã¥ÎãπÏûê ÏßÄÏ†ï ÏóÖÎ¨¥ Ï∂îÏ†Å Î∞è Î∂ÑÏÑù
                </p>
                
                {renderTaskFlow()}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="min-h-screen gradient-bg relative">
      <FloatingShapes />
      
      <div className="relative z-10">
          <Header
            currentView={currentView}
            onViewChange={setCurrentView}
          />
        
        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="mt-4">
            {/* Page Header */}
              <div className="mb-6">
                <Card className="glass-card">
                  <CardHeader>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-3">
                        <div className="p-2 bg-gradient-to-br from-gray-500 to-gray-700 rounded-lg">
                          <FileText className="w-6 h-6 text-white" />
                        </div>
                        <div>
                          <CardTitle className="text-xl font-bold text-gray-800">ÏóÖÎ¨¥Î≥¥Í≥†ÏÑú</CardTitle>
                          <p className="text-sm text-gray-600 mt-1">ÏóÖÎ¨¥ Ïã§Ï†Å Î∞è ÏàòÏπòÎ≥Ñ Î≥¥Í≥†ÏÑú (12Í∞ú ÏóÖÎ¨¥ Í∏∞Ï§Ä)</p>
                        </div>
                      </div>
                      <div className="flex items-center space-x-2">
                        <Button 
                          variant="outline" 
                          size="sm" 
                          className="bg-white/50"
                          onClick={handlePrintPreview}
                        >
                          <Printer className="w-4 h-4 mr-2" />
                          ÎØ∏Î¶¨Î≥¥Í∏∞
                        </Button>
                        <Button 
                          variant="outline" 
                          size="sm" 
                          className="bg-white/50"
                          onClick={handleSavePDF}
                        >
                          <Download className="w-4 h-4 mr-2" />
                          PDFÏ†ÄÏû•
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                </Card>
              </div>

            {/* Report Type Tabs */}
            <Tabs value={reportType} onValueChange={setReportType} className="w-full">
                <TabsList className="grid w-full grid-cols-4 glass-card p-2">
                  <TabsTrigger 
                    value="daily" 
                    className="flex items-center space-x-2 data-[state=active]:bg-gray-600 data-[state=active]:text-white"
                  >
                    <Calendar className="w-4 h-4" />
                    <span>ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑú</span>
                  </TabsTrigger>
                  <TabsTrigger 
                    value="weekly" 
                    className="flex items-center space-x-2 data-[state=active]:bg-gray-600 data-[state=active]:text-white"
                  >
                    <BarChart3 className="w-4 h-4" />
                    <span>Ï£ºÍ∞ÑÎ≥¥Í≥†ÏÑú</span>
                  </TabsTrigger>
                  <TabsTrigger 
                    value="monthly" 
                    className="flex items-center space-x-2 data-[state=active]:bg-gray-600 data-[state=active]:text-white"
                  >
                    <TrendingUp className="w-4 h-4" />
                    <span>ÏõîÍ∞ÑÎ≥¥Í≥†ÏÑú</span>
                  </TabsTrigger>
                  <TabsTrigger 
                    value="yearly" 
                    className="flex items-center space-x-2 data-[state=active]:bg-gray-600 data-[state=active]:text-white"
                  >
                    <Target className="w-4 h-4" />
                    <span>Ïó∞Í∞ÑÎ≥¥Í≥†ÏÑú</span>
                  </TabsTrigger>
                </TabsList>

              {/* Period Navigation */}
                <div className="mt-6">
                  <Card className="glass-card">
                    <CardContent className="p-6">
                      <div className="flex flex-col lg:flex-row lg:items-center gap-4">
                        <div className="flex items-center gap-2">
                          <Button 
                            variant="outline" 
                            size="sm" 
                            onClick={() => navigatePeriod('prev')}
                            className="bg-white/70 border-gray-200 text-gray-800 hover:bg-gray-50"
                          >
                            <ChevronLeft className="w-4 h-4" />
                          </Button>
                          <span className="font-medium text-gray-900 min-w-[200px] text-center px-4 py-2 bg-white/70 rounded-md">
                            {formatPeriodDisplay()}
                          </span>
                          <Button 
                            variant="outline" 
                            size="sm" 
                            onClick={() => navigatePeriod('next')}
                            className="bg-white/70 border-gray-200 text-gray-800 hover:bg-gray-50"
                          >
                            <ChevronRight className="w-4 h-4" />
                          </Button>
                        </div>

                        {reportAnalytics && (
                          <div className="flex items-center gap-4 ml-auto">
                            <Badge className="bg-gray-100 text-gray-800 border-gray-300">
                              Ï¥ù {reportAnalytics.totalTasks}Í∞ú ÏóÖÎ¨¥
                            </Badge>
                            <Badge className="bg-green-100 text-green-800 border-green-300">
                              ÏôÑÎ£åÏú® {reportAnalytics.completionRate}%
                            </Badge>
                          </div>
                        )}
                      </div>
                    </CardContent>
                  </Card>
                </div>

              {/* Loading State */}
              {isLoading && (
                <Card className="glass-card mt-6">
                  <CardContent className="p-8 text-center">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-600 mx-auto mb-4"></div>
                    <p className="text-gray-600">ÏóÖÎ¨¥ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎî© Ï§ë...</p>
                  </CardContent>
                </Card>
              )}

              {/* Report Content */}
              {!isLoading && reportAnalytics && (
                <div className="mt-6 space-y-6">
                  {/* Page 1: Compact Summary Analysis */}
                  <div className="glass-card page-break-inside-avoid">
                    <div className="p-6">
                      <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                        <Eye className="w-5 h-5" />
                        Page 1: ÏöîÏïΩ Î∂ÑÏÑù
                      </h3>
                      <p className="text-gray-600 text-sm mb-4">
                        {getReportTypeLabel()} ÏóÖÎ¨¥ ÏÑ±Í≥º Î∞è ÌïµÏã¨ ÏßÄÌëú
                      </p>
                      
                      {/* Compact Summary Cards */}
                      {renderCompactSummaryCards()}
                      
                      {/* Compact Metrics */}
                      {renderCompactMetrics()}
                    </div>
                  </div>

                  {/* Page 2+: Detailed Task Tables */}
                  <div className="glass-card">
                    <div className="p-6">
                      <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                        <Table className="w-5 h-5" />
                        Page 2+: ÏÉÅÏÑ∏ ÏóÖÎ¨¥ Î™©Î°ù
                      </h3>
                      <p className="text-gray-600 text-sm mb-4">
                        {reportType === 'daily' ? 'Ìï¥ÎãπÏùºÏùò ÏóÖÎ¨¥ÎÇ¥Ïö© Ï†ÑÏ≤¥' :
                         reportType === 'weekly' ? 'Í∞Å ÏùºÎ≥Ñ ÏóÖÎ¨¥ÎÇ¥Ïö© Ï†ÑÏ≤¥' :
                         reportType === 'monthly' ? 'Í∞Å Ï£ºÎ≥Ñ ÏóÖÎ¨¥ÎÇ¥Ïö©' :
                         'Í∞Å ÏõîÎ≥Ñ ÏóÖÎ¨¥ÎÇ¥Ïö©'} Ìëú ÌòïÌÉú ÎÇòÏó¥
                      </p>
                      
                      {renderDetailedReportCompact()}
                    </div>
                  </div>

                  {/* Page 3+: Comprehensive Analysis */}
                  <div className="glass-card">
                    <div className="p-6">
                      <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                        <BarChart3 className="w-5 h-5" />
                        Page 3+: Ï¢ÖÌï© Î∂ÑÏÑù
                      </h3>
                      <p className="text-gray-600 text-sm mb-4">
                        Í∏∞Î≥∏Î∂ÑÏÑùÎÇ¥Ïö© - ÏãúÍ∞ÑÎ∂ÑÏÑù, ÏôÑÎ£åÏú®, Ïö∞ÏÑ†ÏàúÏúÑÎ≥Ñ Î∂ÑÏÑù, Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉùÏÇ∞ÏÑ±, ÏóÖÎ¨¥ÏßëÏ§ëÏãúÍ∞Ñ
                      </p>
                      
                      {renderDetailedAnalysis()}
                    </div>
                  </div>

                  {/* Page 4+: Task Flow Analysis */}
                  <div className="glass-card">
                    <div className="p-6">
                      <h3 className="text-gray-800 font-semibold text-lg flex items-center gap-2 mb-3">
                        <ArrowRight className="w-5 h-5" />
                        Page 4+: ÏóÖÎ¨¥FLOW Î∂ÑÏÑù
                      </h3>
                      <p className="text-gray-600 text-sm mb-4">
                        ÏóÖÎ¨¥FLOW Ìï≠Î™© - ÌõÑÏÜçÎã¥ÎãπÏûê ÏßÄÏ†ï ÏóÖÎ¨¥ Ï∂îÏ†Å Î∞è Î∂ÑÏÑù
                      </p>
                      
                      {renderTaskFlow()}
                    </div>
                  </div>
                </div>
              )}

              {/* No Data State */}
              {!isLoading && (!tasks.length || !reportAnalytics) && (
                <Card className="glass-card mt-6">
                  <CardContent className="p-8 text-center">
                    <FileText className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                    <h3 className="text-xl font-semibold text-gray-900 mb-2">Î∂ÑÏÑùÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                    <p className="text-gray-600 mb-4">
                      {!tasks.length 
                        ? "Îì±Î°ùÎêú ÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§. ÏóÖÎ¨¥Î•º Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî."
                        : "ÏÑ†ÌÉùÎêú Í∏∞Í∞ÑÏóê Ìï¥ÎãπÌïòÎäî ÏóÖÎ¨¥Í∞Ä ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Í∏∞Í∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî."
                      }
                    </p>
                    <Button 
                      onClick={() => window.location.href = '/task-management'}
                      className="bg-gray-600 hover:bg-gray-700 text-white"
                    >
                      ÏóÖÎ¨¥ Í¥ÄÎ¶¨Î°ú Ïù¥Îèô
                    </Button>
                  </CardContent>
                </Card>
              )}
            </Tabs>
          </div>
        </main>
      </div>
    </div>
  );
} 